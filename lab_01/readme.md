# Разбор кода `hello.asm`

Этот код на языке ассемблера для MASM (Microsoft Macro Assembler) создает простую DOS-программу, которая выводит строку "Hello, World!" на экран и затем завершает выполнение программы. Давайте разберем его шаг за шагом.

### Директивы и секции
```masm
.model tiny
.dosseg
.data
```
1. `.model tiny` - указывает на использование tiny-модели памяти. В этой модели и код, и данные находятся в одном сегменте, что упрощает адресацию и организацию программы.
2. `.dosseg` - это директива, специфичная для MASM, которая организует сегменты данных и кода согласно правилам DOS.
3. `.data` - начинает секцию данных, где объявляются и инициализируются данные программы.

### Данные
```masm
    msg db "Hello, World!", 0dh, 0ah, '$'
```
Эта строка определяет данные программы:
- `msg` - это метка, указывающая на начало строки.
- `db` - директива для объявления байтовых данных.
- `"Hello, World!"` - строка символов, которая будет выведена на экран.
- `0dh, 0ah` - это коды возврата каретки (CR) и новой строки (LF), которые используются для переноса строки.
- `'$'` - признак конца строки для функции DOS прерывания 21h с функцией 09h (вывод строки).

### Код
```masm
.code
.startup
```
1. `.code` - начинает секцию кода программы.
2. `.startup` - макрос, который инициализирует выполнение программы (эквивалентно командам `mov ax, @data` и `mov ds, ax`).

### Основная часть программы
```masm
    mov ah, 09h
    mov dx, offset msg
    int 21h
```
Здесь выполняется вывод строки на экран:
1. `mov ah, 09h` - в регистр `AH` загружается значение `09h`, что указывает на функцию DOS 09h (вывод строки).
2. `mov dx, offset msg` - в регистр `DX` загружается адрес строки `msg`. Эта строка должна оканчиваться символом `$` для правильного функционирования этой функции.
3. `int 21h` - вызывается прерывание 21h, которое передает управление функции DOS, указанной в `AH` (в данном случае 09h). Эта функция выводит строку, адрес которой находится в `DX`.

### Завершение программы
```masm
    mov ah, 4ch
    int 21h
end
```
1. `mov ah, 4ch` - в регистр `AH` загружается значение `4Ch`, что указывает на функцию DOS 4Ch (завершение программы).
2. `int 21h` - вызывается прерывание 21h, которое передает управление функции DOS, указанной в `AH` (в данном случае 4Ch). Эта функция завершает выполнение программы и возвращает управление DOS.
3. `end` - заканчивает программу.

### Итог

Этот простой пример демонстрирует базовое взаимодействие с операционной системой DOS через прерывания. Программа использует прерывание 21h для выполнения двух основных задач:

1. **Вывод строки на экран (функция 09h)**:
    - `AH = 09h`: выбирает функцию вывода строки.
    - `DX = offset msg`: указывает на адрес строки, которая будет выведена.
    - `int 21h`: вызывает прерывание, которое обрабатывает вывод строки.

2. **Завершение программы (функция 4Ch)**:
    - `AH = 4Ch`: выбирает функцию завершения программы.
    - `int 21h`: вызывает прерывание, которое завершает выполнение программы и возвращает управление DOS.

Программы на ассемблере для DOS часто взаимодействуют с системой через прерывания, используя регистры для передачи параметров и получения результатов.

# Вопросы

При сдаче лабораторной работы по этому коду на ассемблере могут задать следующие вопросы:

1. **Общие вопросы по коду:**
    - Какую функцию выполняет эта программа?
    - Она выводит строку "Hello, World!" на экран и завершает выполнение программы.

2. **Секции и директивы:**
    - Что обозначает директива `.model tiny`?
    - Почему используется директива `.dosseg`?
    - Для чего предназначены секции `.data` и `.code`?

3. **Работа с данными:**
    - Что означает строка `msg db "Hello, World!", 0dh, 0ah, '$'`?
    - Почему строка заканчивается символом `$`?

4. **Прерывания и функции DOS:**
    - Какую функцию выполняет прерывание `int 21h` с функцией 09h?
    - Что делает прерывание `int 21h` с функцией 4Ch?
    - Какие регистры используются для передачи параметров функции DOS 09h?

5. **Регистр и их значения:**
    - Почему в регистр `AH` загружается значение 09h перед вызовом прерывания 21h?
    - Почему в регистр `DX` загружается адрес строки перед вызовом прерывания 21h?
    - Какие значения регистров используются для завершения программы?

6. **Адресация и память:**
    - Что означает `offset msg`?
    - Какую роль играет регистр `DX` в данном коде?

7. **Системные вызовы:**
    - Какие еще функции можно вызвать через прерывание 21h?
    - Почему завершение программы реализовано через функцию 4Ch?

8. **Завершение программы:**
    - Что происходит при вызове функции 4Ch через прерывание 21h?
    - Можно ли завершить программу другими способами?

9. **Общие знания по ассемблеру:**
    - В чем разница между сегментами кода и данных?
    - Почему важно правильно инициализировать регистры перед вызовом прерываний?

10. **Практические вопросы:**
    - Как изменить программу, чтобы вывести другую строку?
    - Как добавить еще один вывод строки перед завершением программы?

Ответы на эти вопросы помогут продемонстрировать понимание кода и принципов работы ассемблера и взаимодействия с операционной системой DOS.

# Некоторые ответы

Разберем некоторые вопросы подробно.

### Какие еще функции можно вызвать через прерывание 21h?
Прерывание 21h (INT 21h) в операционной системе DOS предоставляет множество функций для работы с системой. Некоторые из них включают:

1. **Вывод и ввод данных:**
    - `AH = 01h`: Ввод символа с клавиатуры с эхо.
    - `AH = 02h`: Вывод символа на экран.
    - `AH = 09h`: Вывод строки на экран (как в вашем коде).

2. **Работа с файлами:**
    - `AH = 3Dh`: Открытие файла.
    - `AH = 3Eh`: Закрытие файла.
    - `AH = 3Fh`: Чтение из файла.
    - `AH = 40h`: Запись в файл.
    - `AH = 41h`: Удаление файла.
    - `AH = 42h`: Перемещение указателя файла (seek).

3. **Работа с памятью:**
    - `AH = 48h`: Выделение блока памяти.
    - `AH = 49h`: Освобождение блока памяти.
    - `AH = 4Ah`: Изменение размера блока памяти.

4. **Работа с процессом:**
    - `AH = 4Ch`: Завершение программы с возвратом кода завершения (как в вашем коде).
    - `AH = 4Dh`: Получение кода завершения предыдущего процесса.

5. **Дата и время:**
    - `AH = 2Ah`: Получение текущей даты.
    - `AH = 2Bh`: Установка текущей даты.
    - `AH = 2Ch`: Получение текущего времени.
    - `AH = 2Dh`: Установка текущего времени.

### Почему завершение программы реализовано через функцию 4Ch?
Функция `AH = 4Ch` используется для завершения программы по нескольким причинам:
1. **Возврат кода завершения:** Эта функция позволяет передать код завершения (состояние выхода) в регистре `AL`, который может быть использован вызывающей программой или оболочкой для определения успешного или неуспешного завершения программы.
2. **Чистое завершение:** Функция 4Ch обеспечивает корректное завершение программы, освобождая все занятые ею ресурсы и возвращая управление операционной системе.
3. **Стандартная практика:** Это стандартный способ завершения программ в DOS, что делает его предсказуемым и надежным.

### Можно ли завершить программу другими способами?
Да, существуют и другие способы завершить программу в DOS:
1. **Функция 00h (Terminate Program):**
   ```asm
   mov ah, 00h
   int 21h
   ```
   Эта функция также завершает программу, но не позволяет вернуть код завершения.

2. **Функция 31h (Terminate and Stay Resident):**
   ```asm
   mov ah, 31h
   mov al, <код завершения>
   int 21h
   ```
   Эта функция завершает программу и делает ее резидентной в памяти.

### В чем разница между сегментами кода и данных?
Сегменты кода и данных различаются по своему назначению и способу использования в программах:

1. **Сегмент кода (Code Segment, CS):**
    - Содержит машинные инструкции, которые выполняются процессором.
    - Читается процессором для выполнения программы.
    - Обычно является только для чтения, чтобы предотвратить изменение кода во время выполнения (в современных системах).

2. **Сегмент данных (Data Segment, DS):**
    - Содержит данные, используемые программой, такие как переменные, массивы, строки и т.д.
    - Читается и записывается программой.
    - Могут быть разные секции данных для разных типов данных (например, инициализированные и неинициализированные данные).

### Пример для сегментов в MASM:
```masm
.data
    myVar db 10     ; Сегмент данных, инициализированная переменная

.code
start:
    mov ax, @data
    mov ds, ax      ; Устанавливаем сегмент данных
    mov al, myVar   ; Читаем переменную из сегмента данных
    mov ah, 4Ch
    int 21h         ; Завершение программы
```

Сегменты обеспечивают организацию и управление памятью в программе, что особенно важно в ассемблере и низкоуровневом программировании.

### Что такое `msg`?

`msg` в вашем коде является **меткой**. Метка в языке ассемблера используется для обозначения адреса в памяти, где начинается определенная часть данных или кода. В данном случае, метка `msg` указывает на начало строки `"Hello, World!", 0dh, 0ah, '$'`, которая хранится в сегменте данных.

### Типы данных в ассемблере (кроме `db`)

В ассемблере MASM есть несколько директив для объявления данных различных типов:

1. **`db` (Define Byte)**:
    - Объявляет байты данных.
    - Пример: `msg db "Hello, World!", 0dh, 0ah, '$'`

2. **`dw` (Define Word)**:
    - Объявляет слова данных (2 байта).
    - Пример: `num dw 1234h`

3. **`dd` (Define Double Word)**:
    - Объявляет двойные слова данных (4 байта).
    - Пример: `longNum dd 12345678h`

4. **`dq` (Define Quad Word)**:
    - Объявляет четверные слова данных (8 байт).
    - Пример: `quadNum dq 123456789ABCDEF0h`

5. **`dt` (Define Ten Bytes)**:
    - Объявляет 10 байт данных.
    - Пример: `tenBytes dt 112233445566778899AABBh`

6. **`db`, `dw`, `dd` с массивами и повторяющимися значениями**:
    - Объявление массивов или инициализация нескольких элементов одним значением.
    - Пример: `array db 10 dup(0)` (создает массив из 10 байтов, инициализированных нулями).

### Примеры использования различных директив

#### Использование `dw`
```masm
.data
    number dw 1234h  ; Объявляет слово (2 байта) с значением 0x1234
```

#### Использование `dd`
```masm
.data
    largeNumber dd 12345678h  ; Объявляет двойное слово (4 байта) с значением 0x12345678
```

#### Использование `dq`
```masm
.data
    veryLargeNumber dq 123456789ABCDEF0h  ; Объявляет четверное слово (8 байт) с значением 0x123456789ABCDEF0
```

#### Использование `dt`
```masm
.data
    tenByteValue dt 112233445566778899AABBh  ; Объявляет 10 байт с указанным значением
```

#### Объявление массива
```masm
.data
    array db 10 dup(0)  ; Объявляет массив из 10 байтов, инициализированных нулями
```

### Итог

Метка `msg` указывает на начало строки данных. Кроме `db`, можно использовать директивы `dw`, `dd`, `dq`, и `dt` для объявления данных различных размеров и типов. Эти директивы позволяют объявлять и инициализировать переменные и массивы с разными типами данных, что важно для управления памятью и данными в программе на ассемблере.

# Разбор кода `hello2.asm`

**Условия сдачи:** `db '$'` вставляли в самые неожиданные места и спрашивали, что произойдет при запуске.
Скомпилируется ли программа, что выведется и т.п. Один из вариантов расположения этой строки рассмотрен ниже.

### Почему выводится мусор из-за `db '$'`?

В языке ассемблера, функция DOS 09h (`AH = 09h`) выводит строку, завершающуюся символом `$`. Это означает, что функция будет считывать и выводить символы из памяти, начиная с адреса, на который указывает регистр `DX`, и до тех пор, пока не встретит символ `$`.

Если символ `$` расположен в неправильном месте или отсутствует, функция продолжит считывать память, что приведет к выводу "мусора" (случайных данных) до тех пор, пока не встретит символ `$` или не выйдет за пределы допустимого диапазона памяти, что может привести к непредсказуемому поведению или сбою программы.

### Анализ вашего кода
```masm
.model tiny
.dosseg
.data
    msg dw "oo", "ll"  ; Определяет 4 байта данных: 'o', 'o', 'l', 'l'
    msg2 db "help"     ; Определяет строку: 'h', 'e', 'l', 'p'
.code
    db '$'             ; Задает символ конца строки (но в сегменте кода)
.startup
    mov ah, 09h
    mov dx, offset msg ; Устанавливает DX на адрес msg
    int 21h            ; Выводит строку по адресу в DX до символа '$'
    mov ah, 4ch
    int 21h            ; Завершает программу
end
```

### Что происходит в вашем коде

1. **Сегмент данных:**
    - `msg dw "oo", "ll"`: Определяет данные "oo", "ll". Это не строка, а два слова, поэтому в памяти это представлено как `0x6F6F` (oo) и `0x6C6C` (ll).
    - `msg2 db "help"`: Определяет строку 'help', но без символа конца строки `$`.

2. **Сегмент кода:**
    - `db '$'`: Определяет символ конца строки `$` в сегменте кода.

3. **Исполнение:**
    - `mov dx, offset msg`: Устанавливает `DX` на адрес `msg`.
    - `int 21h`: Вызывает функцию DOS 09h для вывода строки, которая должна завершаться символом `$`.

### Почему выводится мусор

Так как `msg` содержит данные `dw "oo", "ll"`, они интерпретируются не как строка, а как последовательность байтов, которая не заканчивается символом `$`. Поэтому функция 09h продолжит считывать данные из памяти дальше, что приведет к выводу непредсказуемых символов ("мусора"), пока не встретит `$` или не выйдет за пределы допустимого диапазона.

### Правильное использование

Чтобы корректно использовать вывод строки, нужно:

1. Объявить строку с правильным завершением.
2. Убедиться, что символ конца строки `$` включен в определение строки данных.

### Исправленный код
```masm
.model tiny
.dosseg
.data
    msg db "Hello, World!", 0dh, 0ah, '$'  ; Правильное объявление строки с символом конца строки
    msg2 db "help", '$'                    ; Другой пример строки с символом конца строки
.code
.startup
    mov ah, 09h
    mov dx, offset msg
    int 21h                                ; Выводит строку msg
    mov dx, offset msg2
    int 21h                                ; Выводит строку msg2
    mov ah, 4ch
    int 21h                                ; Завершает программу
end
```

В этом исправленном коде:
- Строка `msg` и `msg2` объявлены правильно, с символом `$` в конце.
- Строки выводятся корректно и завершаются, когда встречается символ `$`, предотвращая вывод "мусора".

### Заключение

Символ конца строки `$` необходимо включать в строки, которые будут выводиться через функцию 09h прерывания 21h. Если `$` расположен неправильно или отсутствует, это приведет к считыванию и выводу непредсказуемых данных.
