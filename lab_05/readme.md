# Разбор кода

Давайте разберем ключевые процедуры кода на MASM. Начнем с главного модуля `main.asm`, затем рассмотрим каждый
из модулей-обработчиков.

### `main.asm`

Основной модуль, обеспечивающий взаимодействие с пользователем и управление программой.

#### Основные элементы:

- **DATA сегмент**:
    - `MENU_PROCEDURES dw 4 dup(?)`: массив указателей на процедуры-обработчики меню.
    - `MENU_MSG` и `INPUT_ITEM_MSG`: строки для вывода меню и запроса выбора пункта.

- **CODE сегмент**:
    - `print_menu`: вывод меню на экран.
    - `init_menu`: инициализация массива `MENU_PROCEDURES` указателями на процедуры-обработчики.
    - `input_menu_item`: ввод пункта меню.
    - `call_func`: вызов соответствующей процедуры на основе выбора пользователя.
    - `main`: основная процедура, управляющая потоком выполнения программы, включая цикл меню и завершение программы.

### Основные процедуры:

#### `print_menu`

Выводит пункты меню на экран.

```asm
print_menu proc
    push dx
    lea dx, MENU_MSG
    call print_str
    pop dx
    ret
print_menu endp
```

#### `init_menu`

Инициализирует массив указателей на обработчики пунктов меню.

```asm
init_menu proc
    push si
    lea si, OFFSET MENU_PROCEDURES
    mov word ptr [si], input_dec
    add si, 2
    mov word ptr [si], output_unsigned_hex
    add si, 2
    mov word ptr [si], output_bin_as_char
    add si, 2
    mov word ptr [si], output_min_power_of_2
    pop si
    ret
init_menu endp
```

#### `input_menu_item`

Запрашивает у пользователя ввод пункта меню и сохраняет его в регистре `dx`.

```asm
input_menu_item proc
    lea dx, INPUT_ITEM_MSG
    call print_str
    call input_digit
    mov dh, 0
    call print_br
    ret
input_menu_item endp
```

#### `call_func`

Вызывает соответствующую процедуру на основе выбора пользователя.

```asm
call_func proc
    push ax
    mov ax, dx
    dec al
    mov bx, 2
    mul bl
    lea bx, MENU_PROCEDURES
    add bx, ax
    call word ptr [bx]
    pop ax
    ret
call_func endp
```

#### `main`

Основной цикл программы.

```asm
main proc
    mov ax, @data
    mov ds, ax
    call init_menu
    loop_menu:
        call print_menu
        call input_menu_item
        cmp dl, 0
        je exit
        call call_func
        jmp loop_menu
    exit:
        mov ax, 4C00h
        int 21h
        ret
main endp
```

### Модули-обработчики

#### `input_dec.asm`

Ввод 16-битного беззнакового десятичного числа.

```asm
input_dec proc
    push ax
    push bx
    push cx
    push dx
    call print_input_dec_msg
    xor ax, ax
    mov num, ax
    mov cx, 5
    input_loop:
        call input_digit
        cmp dl, 10
        ja end_input
        mov dh, 0
        mov ax, num
        mov bl, 10
        mul bl
        add ax, dx
        mov num, ax
        loop input_loop
    end_input:
        call print_br
        pop dx
        pop cx
        pop bx
        pop ax
        ret
input_dec endp
```

#### `output_unsigned_hex.asm`

Вывод числа в шестнадцатеричном формате.

```asm
output_unsigned_hex proc
    push ax
    push cx
    push dx
    push di
    call print_unsigned_hex_msg
    mov ax, num
    mov cx, 4
    hex_output_loop:
        mov di, ax
        and di, 0Fh
        mov dl, HEX_DIGITS[di]
        push dx
        push cx
        mov cl, 4
        shr ax, cl
        pop cx
        loop hex_output_loop
    mov cx, 4
    hex_print_loop:
        pop dx
        call print_sym
        loop hex_print_loop
    call print_br
    pop di
    pop dx
    pop cx
    pop ax
    ret
output_unsigned_hex endp
```

#### `output_bin_as_char.asm`

Вывод числа как знакового байта в двоичном формате.

```asm
output_bin_as_char proc
    push ax
    push cx
    push dx
    call print_bin_output_msg
    mov ax, num
    and ax, 0FFh
    cmp ax, 80h
    jl not_negative
    sub ax, 100h
    not_negative:
    mov cx, 8
    mov dx, ax
    shl dx, cl
    bin_output_loop:
        rol dx, 1
        jc bin_print_1
        jmp bin_print_0
    bin_print_0:
        call print_0
        jmp bin_next
    bin_print_1:
        call print_1
        jmp bin_next
    bin_next:
        loop bin_output_loop
    call print_br
    pop dx
    pop cx
    pop ax
    ret
output_bin_as_char endp
```

#### `output_min_power_of_2.asm`

Вывод минимальной степени двойки, превышающей введенное число.

```asm
output_min_power_of_2 proc
    push ax
    push dx
    call print_power_of_2_msg
    mov dx, 0
    mov ax, 1
    power_loop:
        cmp ax, num
        ja power_done
        shl ax, 1
        inc dx
        jmp power_loop
    power_done:
        call print_dec
        call print_br
        pop dx
        pop ax
        ret
output_min_power_of_2 endp
```

### Модуль `io.asm`

Содержит процедуры ввода/вывода символов и чисел.

#### Основные процедуры:

- `print_sym`: вывод символа.
- `print_digit`: вывод цифры.
- `print_str`: вывод строки.
- `input_sym`: ввод символа.
- `input_digit`: ввод цифры.

### Заключение

Код организован согласно требованиям. Основной модуль отвечает за управление потоком программы и взаимодействие с
пользователем через меню. Каждый модуль-обработчик выполняет конкретные задачи: ввод числа, вывод в различных форматах и
вычисление минимальной степени двойки. Модуль ввода/вывода обеспечивает базовые функции для работы с текстом и цифрами.

# Принцип работы и необходимая теория

Давайте подробно рассмотрим принцип работы кода и необходимую теорию для каждого модуля обработчика в вашем MASM проекте.

### Модуль `input_dec.asm`
#### Принцип работы:
Этот модуль отвечает за ввод 16-разрядного беззнакового числа в десятичной системе счисления.

1. **Инициализация и вывод сообщения**:
  - Выводится сообщение с приглашением ввести число.
  - Регистр `num` инициализируется нулем для хранения введенного числа.

2. **Ввод цифр**:
  - Цикл ввода повторяется до пяти раз (максимальное число цифр для 16-битного числа).
  - Каждая введенная цифра проверяется на соответствие (0-9).
  - Введенная цифра преобразуется и добавляется к текущему значению числа.

3. **Арифметические операции**:
  - Текущее значение числа умножается на 10.
  - Введенная цифра добавляется к текущему значению.

4. **Завершение ввода**:
  - Если введена некорректная цифра, ввод завершается досрочно.
  - Введенное число сохраняется в переменной `num`.

#### Необходимая теория:
- **Регистры и операции над ними**:
  - Регистр `ax` используется для хранения текущего значения числа.
  - Регистр `dx` используется для временного хранения введенной цифры.
  - Регистры `cx` и `bx` используются для счетчика цикла и множителя (10) соответственно.

- **Прерывания DOS**:
  - Прерывание `int 21h` используется для ввода символов и вывода строк.

- **Арифметика в ассемблере**:
  - Операция умножения (`mul`) и сложения (`add`) используются для расчета текущего значения числа.

### Модуль `output_unsigned_hex.asm`
#### Принцип работы:
Этот модуль отвечает за вывод числа в шестнадцатеричной системе счисления.

1. **Инициализация и вывод сообщения**:
  - Выводится сообщение с пояснением о выводе числа в шестнадцатеричном формате.

2. **Преобразование в шестнадцатеричный формат**:
  - Цикл повторяется 4 раза (для 16-битного числа нужно 4 цифры).
  - Каждая цифра определяется по 4-м младшим битам числа.
  - Цифра помещается в стек для вывода в правильном порядке.

3. **Вывод цифр**:
  - Цифры извлекаются из стека и выводятся на экран.

#### Необходимая теория:
- **Системы счисления**:
  - Шестнадцатеричная система счисления использует 16 символов: 0-9 и A-F.
  - Каждая шестнадцатеричная цифра соответствует 4 битам.

- **Работа со стеком**:
  - Стек используется для временного хранения цифр для вывода их в правильном порядке.

- **Побитовые операции**:
  - Операция `and` используется для получения младших 4 бит числа.
  - Операция сдвига вправо (`shr`) используется для обработки следующей цифры.

### Модуль `output_bin_as_char.asm`
#### Принцип работы:
Этот модуль отвечает за вывод числа как знакового байта в двоичном формате.

1. **Инициализация и вывод сообщения**:
  - Выводится сообщение с пояснением о выводе числа в двоичном формате.

2. **Преобразование в знаковый байт**:
  - Оставляем младшие 8 бит числа.
  - Если число больше или равно 128 (0x80), вычитаем 256 (0x100), чтобы получить отрицательное значение.

3. **Вывод в двоичном формате**:
  - Цикл повторяется 8 раз (для 8 бит).
  - Каждый бит выводится поочередно, начиная со старшего.

#### Необходимая теория:
- **Системы счисления**:
  - Двоичная система счисления использует 2 символа: 0 и 1.

- **Знаковые и беззнаковые числа**:
  - Преобразование из беззнакового 8-битного числа в знаковое происходит путем вычитания 256, если число больше или равно 128.

- **Побитовые операции**:
  - Операция сдвига влево (`shl`) используется для подготовки числа к выводу битов.
  - Операция циклического сдвига (`rol`) используется для извлечения каждого бита.

### Модуль `output_min_power_of_2.asm`
#### Принцип работы:
Этот модуль отвечает за вывод минимальной степени двойки, превышающей введенное число.

1. **Инициализация и вывод сообщения**:
  - Выводится сообщение с пояснением о выводе степени двойки.

2. **Поиск степени двойки**:
  - Начальное значение устанавливается на 1 (2^0).
  - Цикл продолжается, пока текущее значение степени двойки не превысит введенное число.
  - В каждой итерации значение удваивается, а счетчик степени увеличивается.

3. **Вывод результата**:
  - Выводится найденная степень двойки.

#### Необходимая теория:
- Степени двойки растут экспоненциально: 2^0, 2^1, 2^2 и т.д.
- Операция сдвига влево (`shl`) используется для удвоения текущего значения.
- Цикл продолжается до тех пор, пока текущее значение степени двойки не станет больше введенного числа.
