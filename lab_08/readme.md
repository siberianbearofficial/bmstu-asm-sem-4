# Математический сопроцессор (FPU)

## Теоретическая справка по FPU

### Введение

Сопроцессор с плавающей точкой (FPU, Floating Point Unit) предназначен для выполнения операций с числами с плавающей
точкой (вещественными числами). В x86-64 архитектуре FPU является частью набора инструкций SSE (Streaming SIMD
Extensions) и AVX (Advanced Vector Extensions). В современных процессорах FPU интегрирован в основной процессор и
способен выполнять сложные арифметические операции с высокой скоростью.

### Основные компоненты FPU

1. **Регистры**: В FPU имеются специальные регистры для хранения чисел с плавающей точкой. В x86-64 архитектуре
   используются регистры `xmm0`-`xmm15` для операций SSE и `ymm0`-`ymm15` для AVX.
2. **Инструкции**: FPU поддерживает различные инструкции для выполнения арифметических операций (сложение, вычитание,
   умножение, деление), а также для работы с тригонометрическими функциями, логарифмами и экспонентами.
3. **Форматы данных**: FPU работает с различными форматами чисел с плавающей точкой, такими как 32-битные (float) и
   64-битные (double).

### Использование FPU в NASM и C

Для использования FPU в NASM (Netwide Assembler) и C на macOS, необходимо:

1. Написать ассемблерный код для выполнения требуемых операций.
2. Интегрировать этот код в программу на C с помощью встроенных ассемблерных вставок или отдельного ассемблерного файла.

# Реализация на Python

Для лучшего понимания происходящего был написан код на Python, реализующий метод половинного деления для нахождения
корня функции cos(x^3 + 7). Он является эквивалентом кода на C с ассемблерными вставками, предоставляя более простой и
читаемый способ выполнения тех же вычислений.

### Импорт модуля

```python
from math import cos
```

Мы импортируем функцию `cos` из модуля `math`, чтобы вычислять косинус.

### Определение функции `f`

```python
def f(value):
    return cos(value ** 3 + 7)
```

Функция `f` принимает одно значение `value` и возвращает результат вычисления cos(value^3 + 7).

### Основная функция `root`

```python
def root(a, b, steps):
    if f(a) * f(b) > 0:
        return None
```

Функция `root` принимает три параметра:

- `a`: начало отрезка
- `b`: конец отрезка
- `steps`: количество шагов, которые будут выполнены в процессе поиска корня

Сначала проверяется, что значения функции в точках `a` и `b` имеют разные знаки. Если это не так (`f(a) * f(b) > 0`),
возвращается `None`, так как метод половинного деления не применим.

#### Цикл поиска корня

```python
    for _ in range(steps):
    f_a = f(a)
    mid = (a + b) / 2
    f_mid = f(mid)
```

Цикл выполняется `steps` раз. На каждом шаге вычисляется:

- `f_a`: значение функции в точке `a`
- `mid`: середина отрезка \((a + b) / 2\)
- `f_mid`: значение функции в точке `mid`

#### Проверка значения функции в середине

```python
        if f_mid == 0:
    return mid
```

Если значение функции в точке `mid` равно нулю, возвращается `mid` как найденный корень.

#### Определение следующего отрезка

```python
        if f_a * f_mid < 0:
    b = mid
else:
    a = mid
```

Если произведение значений функции в точках `a` и `mid` меньше нуля, корень находится в левом подотрезке, и `b`
устанавливается равным `mid`. В противном случае корень находится в правом подотрезке, и `a` устанавливается
равным `mid`.

#### Окончательное вычисление середины отрезка

```python
    mid = (a + b) / 2

return mid
```

После выполнения всех шагов вычисляется окончательная середина отрезка и возвращается как результат.

### Вызов функции `root` и вывод результата

```python
print(round(root(1.5, 1.75, 10000), 6))
```

Функция `root` вызывается с параметрами `a = 1.5`, `b = 1.75`, и `steps = 10000`. Найденный корень округляется до шести
знаков после запятой и выводится на экран.
В основном коде на си и ассемблере будем проходить те же шаги решения задачи, что и в коде на питоне.

# Разбор основного кода

Перейдем к разбору основного кода.
Он написан на языке C и использует вставки на ассемблере для выполнения основных вычислений.

### Общее описание функции

```c
/**
 * Поиск корня функции cos(x^3 + 7) методом половинного деления.
 * @param a: начало отрезка
 * @param b: конец отрезка
 * @param steps: количество шагов
 * @return: найденный корень
 */
double root(double a, double b, int steps) {
...
}
```

Функция `root` принимает три параметра:

- `a`: начало отрезка
- `b`: конец отрезка
- `steps`: количество шагов, которые будут выполнены в процессе поиска корня.

### Переменные

В функции объявлены следующие переменные:

- `result`: переменная для хранения найденного корня.
- `c2`: константа, равная 2 (используется для деления отрезка пополам).
- `c7`: константа, равная 7 (используется в формуле cos(x^3 + 7)).
- `mid`: середина отрезка.
- `f_a`: значение функции в точке `a`.
- `f_mid`: значение функции в точке `mid`.

### Ассемблерный блок

Основная часть работы функции выполняется внутри ассемблерного блока.

#### Метки

Используются метки для организации циклов и переходов:

- `main_loop`: основная часть цикла, выполняющаяся `steps` раз.
- `set_a`: установка значения `a` на середину отрезка.
- `set_b`: установка значения `b` на середину отрезка.
- `last_mid`: вычисление окончательной середины отрезка после выхода из цикла.
- `done`: завершение работы и возвращение результата.

#### Основной цикл

В начале основного цикла вычисляется значение функции в точке `a`:

```assembly
fldl %6           // загрузка a
fmull %6          // x^2
fmull %6          // x^3
faddl %2          // x^3 + 7
fcos              // cos(x^3 + 7)
fstpl %4          // сохранение результата в f_a
```

Затем вычисляется середина отрезка:

```assembly
fldl %6           // загрузка a
faddl %7          // добавление b
fdivl %1          // деление на 2
fstpl %3          // сохранение результата в mid
```

После этого вычисляется значение функции в середине:

```assembly
fldl %3           // загрузка mid
fmull %3          // x^2
fmull %3          // x^3
faddl %2          // x^3 + 7
fcos              // cos(x^3 + 7)
fstpl %5          // сохранение результата в f_mid
```

#### Проверка значения функции в середине

Проверяется, равно ли значение функции в середине нулю (если так, найден корень):

```assembly
fldl %5           // загрузка f_mid
ftst              // сравнение с 0
fstsw %%ax        // сохранение статуса в AX
fstpl %5          // очистка стека
sahf              // загрузка флагов
jz done           // переход к завершению, если f_mid == 0
```

#### Определение следующего отрезка

Если произведение значений функции в точках `a` и `mid` меньше нуля, то корень находится в левом подотрезке:

```assembly
fldl %4           // загрузка f_a
fmull %5          // умножение на f_mid
ftst              // сравнение с 0
fstsw %%ax        // сохранение статуса в AX
fstpl %0          // очистка стека
sahf              // загрузка флагов
jb set_b          // если меньше нуля, установить b = mid
jmp set_a         // иначе установить a = mid
```

#### Установка значений `a` и `b`

```assembly
set_a:
fldl %3           // загрузка mid
fstpl %6          // сохранение mid в a
loop main_loop    // повторение цикла

set_b:
fldl %3           // загрузка mid
fstpl %7          // сохранение mid в b
loop main_loop    // повторение цикла
```

#### Завершение

После завершения всех шагов вычисляется окончательная середина отрезка и возвращается как результат:

```assembly
last_mid:
fldl %6           // загрузка a
faddl %7          // добавление b
fdivl %1          // деление на 2
fstpl %3          // сохранение результата в mid
jmp done          // переход к завершению

done:
fldl %3           // загрузка mid
fstpl %0          // сохранение результата в result
```

### Функция `main`

Функция `main` вызывает функцию `root` с заданными параметрами и выводит найденный корень:

```c
int main() {
    double result = root(1.5, 1.75, 10000);
    printf("%lf\n", result);
    return 0;
}
```

### Заключение

Код находит корень функции cos(x^3 + 7) на заданном отрезке методом половинного деления с использованием ассемблерных
вставок для выполнения основных математических операций.
