# Разбор кода

Этот пример на языке ассемблера MASM демонстрирует взаимодействие двух файлов, манипуляцию видеопамятью в текстовом режиме и использование стека. Давайте подробно разберем каждый файл и их взаимодействие.

## Первый файл (main.asm)

### Сегмент стека

```asm
STK SEGMENT PARA STACK 'STACK'
	db 100 dup(0)
STK ENDS
```

Этот сегмент определяет стек размером 100 байт.

### Сегмент данных

```asm
DSEG SEGMENT PARA PUBLIC 'DATA'
	X db 'R'
DSEG ENDS
```

Сегмент данных, содержащий переменную `X`, инициализированную символом 'R'.

### Сегмент кода

```asm
CSEG SEGMENT PARA PUBLIC 'CODE'
	assume CS:CSEG, DS:DSEG, SS:STK
main:
	mov ax, DSEG
	mov ds, ax

	call output_X	

	mov ax, 4c00h
	int 21h
CSEG ENDS
```

Этот сегмент содержит код программы. Здесь:
1. Устанавливается сегментный регистр `DS` для указания на сегмент данных.
2. Выполняется вызов процедуры `output_X`, которая находится во втором файле.
3. Завершается программа с помощью DOS-функции 4Ch.

### Объявление публичных символов

```asm
PUBLIC X
END main
```

Здесь `X` объявляется как публичная переменная, доступная другим модулям.

## Второй файл (output.asm)

### Публичные и внешние символы

```asm
PUBLIC output_X
EXTRN X: byte
```

Процедура `output_X` объявляется как публичная, а переменная `X` — как внешняя.

### Сегмент видеопамяти

```asm
DS2 SEGMENT AT 0b800h
	CA LABEL byte
	ORG 80 * 2 * 2 + 2 * 2
	SYMB LABEL word
DS2 ENDS
```

Этот сегмент указывает на видеопамять, начиная с адреса 0b800h (текстовый режим видеопамяти VGA). Смещение `ORG 80 * 2 * 2 + 2 * 2` устанавливает адрес для `SYMB` на позиции (2,2) в строке 2 (это не точно).

### Сегмент кода

```asm
CSEG SEGMENT PARA PUBLIC 'CODE'
	assume CS:CSEG, ES:DS2
output_X proc near
	mov ax, DS2
	mov es, ax
	mov ah, 10001100b
	mov al, X
	mov symb, ax
	ret
output_X endp
CSEG ENDS
END
```

Процедура `output_X`:
1. Устанавливает сегментный регистр `ES` на сегмент видеопамяти `DS2`.
2. Устанавливает регистр `AX` значением `10001100b` в старшем байте (AH) и значением переменной `X` в младшем байте (AL).
3. Записывает значение регистра `AX` в `symb`, то есть по адресу видеопамяти (положение 2,2).

### Работа с видеопамятью

В текстовом режиме видеопамять VGA начинается с адреса 0b800h. Каждое отображаемое на экране символное место занимает 2 байта:
- Один байт для ASCII-кода символа.
- Один байт для атрибутов символа (цвет фона и текста).

В этом примере:
- `mov ah, 10001100b` устанавливает атрибуты символа. Значение `10001100b` (140 в десятичной системе) соответствует цвету: мигающий текст красного цвета на черном фоне.
- `mov al, X` загружает в регистр `AL` значение переменной `X` ('R').

### Объединение всего вместе

При вызове процедуры `output_X` в `main.asm`, процедура записывает символ 'R' мигающим красным текстом на черном фоне в видеопамять по позиции (2,2) (не точно).

## Заключение

Этот пример демонстрирует:
1. Использование сегментов для организации кода, данных и стека.
2. Взаимодействие двух модулей с помощью публичных и внешних объявлений.
3. Манипуляцию видеопамятью в текстовом режиме VGA.
4. Установку атрибутов символов, где `ah` содержит биты, отвечающие за цвет текста и фона.