# Разбор кода

Код написан для создания резидентной программы, которая изменяет скорость автоповтора ввода символов с клавиатуры.
Резидентные программы остаются в памяти после завершения и могут продолжать выполнять некоторые функции.

### Общая структура программы

1. **Модель tiny**: Это означает, что программа будет компактной и не будет использовать сегментацию памяти.
2. **Отступ org 100h**: Начало программы смещается на 100h байт, так как в .COM-файлах заголовок занимает первые 256
   байт.

### Метка main и инициализация

```asm
main:
    jmp init
```

Программа сразу переходит к метке `init`, пропуская данные и процедуры, объявленные перед ней.

### Объявление данных

```asm
is_inited       db 1                ; Признак того, что резидент установлен
cur_speed       db 1Fh              ; Начальная скорость автоповтора ввода (2 символа в секунду)
cur_time        db 0                ; Время в секундах
```

### Процедура `inc_input_speed`

Эта процедура будет вызвана при срабатывании прерывания таймера.

```asm
inc_input_speed proc near
    mov ah, 02h
    int 1Ah                             ; Получаем текущее время с помощью BIOS прерывания 1Ah

    cmp dh, cur_time
    je skip_speed_change                ; Если время не изменилось, пропускаем изменение скорости

    mov cur_time, dh                    ; Обновляем текущее время
    dec cur_speed                       ; Уменьшаем скорость автоповтора

    cmp cur_speed, 1Fh                  ; Если скорость меньше минимальной, устанавливаем минимальную скорость
    jbe set_speed

    mov cur_speed, 1Fh

    set_speed:
        mov al, 0F3h                    ; Команда для настройки автоповтора
        out 60h, al
        mov al, cur_speed
        out 60h, al                     ; Устанавливаем новую скорость автоповтора

    skip_speed_change:
        db 0EAh                         ; Прямой переход к старому обработчику прерывания
        handler_segment dw 0
        handler_addr dw 0

inc_input_speed endp
```

### Инициализация программы

```asm
init:
    mov ax, 351Ch
    int 21h                             ; Получаем адрес текущего обработчика прерывания таймера

    cmp es:is_inited, 1
    je exit                             ; Если программа уже установлена, выходим

    mov handler_segment, bx
    mov handler_addr, es

    mov ax, 251Ch
    mov dx, offset inc_input_speed
    int 21h                             ; Устанавливаем новый обработчик прерывания таймера

    mov dx, offset init_msg
    mov ah, 09h
    int 21h                             ; Выводим сообщение об установке

    mov dx, offset init
    int 27h                             ; Завершаем программу резидентной

exit:
    mov dx, offset exit_msg
    mov ah, 09h
    int 21h                             ; Выводим сообщение о завершении

    mov al, 0F3h
    out 60h, al
    mov al, 0
    out 60h, al                         ; Восстанавливаем дефолтные значения автоповтора

    mov dx, es:handler_segment
    mov ds, es:handler_addr
    mov ax, 251Ch
    int 21h                             ; Восстанавливаем старый обработчик прерывания

    mov ah, 49h
    int 21h                             ; Освобождаем память

    mov ax, 4c00h
    int 21h                             ; Завершаем программу

init_msg db 'New interrupt handler installed.', '$', 10, 13
exit_msg db 'New interrupt handler uninstalled.', '$', 10, 13
```

### Резидентные программы

Резидентные программы остаются в памяти после завершения и могут выполнять некоторые функции по таймеру или другим
событиям. В этом коде программа захватывает прерывание таймера (INT 1Ch), изменяя скорость автоповтора ввода символов с
клавиатуры.

### Работа с портами ввода-вывода

Порты ввода-вывода (I/O ports) используются для взаимодействия с аппаратным обеспечением. В данном коде используются
порты для настройки параметров клавиатуры:

```asm
mov al, 0F3h
out 60h, al
mov al, cur_speed
out 60h, al
```

- **Порт 60h**: Этот порт используется для передачи данных клавиатуре.
- **Команда 0F3h**: Эта команда предназначена для установки режима автоповтора клавиатуры.

### Заключение

Этот код демонстрирует, как можно создать резидентную программу, изменяющую параметры автоповтора клавиатуры, используя
прерывания и порты ввода-вывода.
Это требует понимания работы с прерываниями, портами и особенностями резидентных программ.
